apiVersion: v1
kind: Pod
metadata:
  name: {{ job_name }}
  labels:
    job_batch: {{ task_name }}
    job-name: {{ job_name }}
    app-name: asset-sniper
spec:
  initContainers:
  - name: init-dns
    image: busybox
    command: ["/bin/sh", "-c"]
    args:
    - |
      host_ip=$(nslookup asset-sniper-ip-rotator.default.svc.cluster.local | awk '/Address: / { print $2 }' | tail -n1)
      echo "http://${host_ip}:8888" > /shared/proxy

      RESOLVERS=$(cat /etc/dns-config/resolvers)

      # Update the custom resolv.conf
      {
        echo "# Generated by init container"
        for dns in $RESOLVERS; do
          echo "nameserver $dns";
        done
        echo "options ndots:0";
      } > /resolv/resolv.conf
    volumeMounts:
    - name: dns-config
      mountPath: /etc/dns-config
    - name: resolv
      mountPath: /resolv
    - name: shared
      mountPath: /shared
  - name: init-proxy
    image: busybox
    command: ["/bin/sh", "-c"]
    args:
      - |
        while [ ! -f /shared/proxy ]; do sleep 1; done;
        echo "export HTTP_PROXY=$(cat /shared/proxy)" > /env-vars/proxy.env;
        echo "export HTTPS_PROXY=$(cat /shared/proxy)" >> /env-vars/proxy.env;
    volumeMounts:
      - name: shared
        mountPath: /shared
      - name: env-vars
        mountPath: /env-vars
  containers:
    - name: asset-sniper
      image: vitobotta/katana:v2fa2da6
      imagePullPolicy: IfNotPresent
      command: ["/bin/sh", "-c"]
      args: ["source /env-vars/proxy.env; while true; do sleep 3600; done"]
      readinessProbe:
        exec:
          command: ["/bin/sh", "-c", "test -f /shared/proxy"]
        initialDelaySeconds: 3
        periodSeconds: 3
      volumeMounts:
      - name: resolv
        mountPath: /etc/resolv.conf
        subPath: resolv.conf
      - name: shared
        mountPath: /shared/proxy
        subPath: proxy
      - name: env-vars
        mountPath: /env-vars
      resources:
        requests:
          cpu: 3
          memory: 7Gi
        limits:
          cpu: 3
          memory: 7Gi
  volumes:
  - name: dns-config
    configMap:
      name: asset-sniper-dns-resolvers
  - name: resolv
    emptyDir: {}
  - name: shared
    emptyDir: {}
  - name: env-vars
    emptyDir: {}
  restartPolicy: Never

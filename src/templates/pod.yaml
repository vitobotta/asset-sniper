apiVersion: v1
kind: Pod
metadata:
  name: {{ job_name }}
  labels:
    job_batch: {{ task_name }}
    job-name: {{ job_name }}
    app-name: asset-sniper
spec:
  initContainers:
  - name: init-dns
    image: busybox
    command: ["/bin/sh", "-c"]
    args:
    - |
      # Read DNS servers from the mounted config map file
      RESOLVERS=$(cat /etc/dns-config/resolvers)

      # Update the custom resolv.conf
      {
        echo "# Generated by init container"
        for dns in $RESOLVERS; do
          echo "nameserver $dns";
        done
      } > /etc/custom-resolv.conf

      # Copy updated resolv.conf to the mounted path
      cp /etc/custom-resolv.conf /etc/mounted-resolv/resolv.conf

    volumeMounts:
    - name: dns-config
      mountPath: /etc/dns-config
    - name: resolv-conf
      mountPath: /etc/mounted-resolv
  containers:
    - name: asset-sniper
      image: vitobotta/assetsniper:vbefb074
      imagePullPolicy: IfNotPresent
      command: ["/bin/sh", "-c"]
      args: ["tail -f /dev/null"]
      volumeMounts:
      - name: dns-config
        mountPath: /etc/dns-config
      - name: resolv-conf
        mountPath: /etc/resolv.conf
        subPath: resolv.conf
      resources:
        requests:
          cpu: 0.1
          memory: 200Mi
  volumes:
  - name: dns-config
    configMap:
      name: {{ task_name }}-dns-resolvers
  - name: resolv-conf
    emptyDir: {}
  restartPolicy: Never

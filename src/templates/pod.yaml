apiVersion: v1
kind: Pod
metadata:
  name: {{ job_name }}
  labels:
    job_batch: {{ task_name }}
    job-name: {{ job_name }}
    app-name: asset-sniper
spec:
  initContainers:
  - name: init-dns
    image: busybox
    command: ["/bin/sh", "-c"]
    args:
    - |
      host_ip=$(nslookup asset-sniper-ip-rotator.default.svc.cluster.local | awk '/Address: / { print $2 }' | tail -n1)
      echo "http://${host_ip}:8888" > /shared/proxy

      RESOLVERS=$(cat /etc/dns-config/resolvers)

      # Update the custom resolv.conf
      {
        echo "# Generated by init container"
        for dns in $RESOLVERS; do
          echo "nameserver $dns";
        done
        echo "options ndots:0";
      } > /resolv/resolv.conf
    volumeMounts:
    - name: dns-config
      mountPath: /etc/dns-config
    - name: resolv
      mountPath: /resolv
    - name: shared
      mountPath: /shared
  containers:
    - name: asset-sniper
      image: vitobotta/katana:v2fa2da6
      imagePullPolicy: IfNotPresent
      command: ["/bin/sh", "-c"]
      args: ["tail -f /dev/null"]
      volumeMounts:
      - name: resolv
        mountPath: /etc/resolv.conf
        subPath: resolv.conf
      - name: shared
        mountPath: /shared/proxy
        subPath: proxy
      resources:
        requests:
          cpu: 2
          memory: 2Gi
        limits:
          cpu: 2
          memory: 2Gi
  volumes:
  - name: dns-config
    configMap:
      name: {{ task_name }}-dns-resolvers
  - name: resolv
    emptyDir: {}
  - name: shared
    emptyDir: {}
  restartPolicy: Never
